name: Deploy App Update

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  refresh-instances:
    name: "Fast Update (Aggressive)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      # VERSIÓN AGRESIVA:
      # 1. MinHealthyPercentage = 0 (No espera a nadie, reemplaza todo de golpe)
      # 2. InstanceWarmup = 0 (Asume que la instancia está lista apenas nace)
      - name: Aggressive Instance Refresh
        run: |
          ASG_NAME="my-app-asg-v2"

          echo "1. Cancelando cualquier proceso anterior..."
          aws autoscaling cancel-instance-refresh --auto-scaling-group-name $ASG_NAME || true

          # Esperamos solo un momento breve
          sleep 5

          echo "2. ¡Lanzando actualización AGRESIVA!"
          # Al poner MinHealthyPercentage en 0, AWS no se bloquea esperando salud.
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name $ASG_NAME \
            --preferences '{"MinHealthyPercentage": 0, "InstanceWarmup": 0}' \
            --strategy Rolling
